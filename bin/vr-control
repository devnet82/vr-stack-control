#!/usr/bin/env bash
set -Eeuo pipefail

APP_VERSION="v0.6.85-openxrfix9-close-steam-on-wivrn21"

usage() {
  cat <<USAGE
VR Stack Control $APP_VERSION

Usage:
  vr-control --gui            Open the GTK control panel (default)
  vr-control tray             Start tray icon
  vr-control tray-enable      Enable + start tray service (autostart)
  vr-control tray-disable     Disable + stop tray service
  vr-control start            Start the VR stack via systemd --user
  vr-control stop             Stop the VR stack via systemd --user
  vr-control restart          Restart the VR stack via systemd --user
  vr-control status           Show service status
  vr-control logs             Follow logs for vr-stack-control.service
  vr-control doctor           Print a health report (OpenXR/OpenVR/services)
  vr-control --version        Print version
  vr-control --help           Show this help
USAGE
}

if [[ ${1-} == "" || ${1-} == "--gui" || ${1-} == "gui" ]]; then
  shift || true
  exec "${HOME}/.local/bin/vr-control-gui" "$@"
fi

case "${1-}" in
  --help|-h)
    usage
    ;;
  --version|-V|version)
    echo "$APP_VERSION"
    ;;
  tray)
    exec "${HOME}/.local/bin/vr-stack-tray"
    ;;
  tray-enable)
    exec systemctl --user enable --now vr-stack-tray.service
    ;;
  tray-disable)
    exec systemctl --user disable --now vr-stack-tray.service
    ;;
  start)
    exec systemctl --user start vr-stack-control.service
    ;;
  stop)
    exec systemctl --user stop vr-stack-control.service
    ;;
  restart)
    exec systemctl --user restart vr-stack-control.service
    ;;
  status)
    exec systemctl --user status vr-stack-control.service --no-pager -l
    ;;
  doctor)
    exec "${HOME}/.local/bin/vr-doctor"
    ;;
  logs)
    exec journalctl --user -fu vr-stack-control.service
    ;;
  *)
    echo "Unknown command: ${1-}" >&2
    usage >&2
    exit 2
    ;;
 esac
