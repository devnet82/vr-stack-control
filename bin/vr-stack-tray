#!/usr/bin/env python3
import os
import sys
import subprocess
from pathlib import Path

APP_VERSION = "v0.6.85-openxrfix9-close-steam-on-wivrn21"

HOME = Path.home()
VR_CONTROL_GUI = str(HOME / ".local" / "bin" / "vr-control-gui")
VR_CONTROL = str(HOME / ".local" / "bin" / "vr-control")

def sh(cmd: str) -> int:
    return subprocess.call(cmd, shell=True)

def open_gui(*_):
    # Use absolute path so it works when started via systemd without full PATH.
    if os.path.exists(VR_CONTROL_GUI):
        subprocess.Popen([VR_CONTROL_GUI], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    else:
        subprocess.Popen(["xdg-open", "applications://vr-control-panel.desktop"],
                         stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

def start_stack(*_):
    sh("systemctl --user start vr-stack-control.service || true")

def stop_stack(*_):
    sh("systemctl --user stop vr-stack-control.service || true")

def quit_stop_stack(*_):
    # Stop the whole stack, then stop this tray service.
    sh("systemctl --user stop vr-stack-control.service || true")
    sh("systemctl --user stop vr-stack-tray.service || true")
    sys.exit(0)

def show_logs(*_):
    # Open logs in a terminal if possible
    if sh("command -v foot >/dev/null 2>&1") == 0:
        subprocess.Popen(["foot", "-e", "journalctl", "--user", "-fu", "vr-stack-control.service"])
    elif sh("command -v konsole >/dev/null 2>&1") == 0:
        subprocess.Popen(["konsole", "-e", "journalctl", "--user", "-fu", "vr-stack-control.service"])
    elif sh("command -v xterm >/dev/null 2>&1") == 0:
        subprocess.Popen(["xterm", "-e", "journalctl", "--user", "-fu", "vr-stack-control.service"])
    else:
        sh("journalctl --user -n 120 -u vr-stack-control.service --no-pager || true")

def doctor_report(*_):
    """Run doctor in a terminal and keep the window open until the user closes it."""
    if os.path.exists(VR_CONTROL):
        inner = f'"{VR_CONTROL}" doctor'
    else:
        inner = 'echo "vr-control not installed"'

    # Keep the terminal open so the user can read the output.
    shell = f"{inner}; echo; echo '(Press Enter to close)'; read -r"
    cmd = ["bash", "-lc", shell]

    if sh("command -v foot >/dev/null 2>&1") == 0:
        subprocess.Popen(["foot", "-e"] + cmd)
    elif sh("command -v konsole >/dev/null 2>&1") == 0:
        subprocess.Popen(["konsole", "--hold", "-e"] + cmd)
    elif sh("command -v xterm >/dev/null 2>&1") == 0:
        subprocess.Popen(["xterm", "-hold", "-e"] + cmd)
    else:
        subprocess.Popen(cmd)



def build_menu():
    import gi
    gi.require_version("Gtk", "3.0")
    from gi.repository import Gtk

    menu = Gtk.Menu()

    def add(label, cb):
        item = Gtk.MenuItem(label=label)
        item.connect("activate", cb)
        item.show()
        menu.append(item)

    add("Open GUI", open_gui)
    add("Start stack", start_stack)
    add("Stop stack", stop_stack)
    add("Doctor report", doctor_report)
    add("Logs", show_logs)
    add("Quit (stop stack + exit)", quit_stop_stack)
    return menu


def main():
    import gi
    gi.require_version("Gtk", "3.0")
    from gi.repository import Gtk

    menu = build_menu()

    Indicator = None
    for name in ("AyatanaAppIndicator3", "AppIndicator3"):
        try:
            gi.require_version(name, "0.1")
            Indicator = getattr(__import__("gi.repository", fromlist=[name]), name)
            break
        except Exception:
            continue

    if Indicator is not None:
        print(f"[vr-stack-tray] using {Indicator.__name__}", flush=True)
        indicator = Indicator.Indicator.new(
            "vr-stack-control",
            "video-display",
            Indicator.IndicatorCategory.APPLICATION_STATUS,
        )
        indicator.set_status(Indicator.IndicatorStatus.ACTIVE)
        indicator.set_menu(menu)
        Gtk.main()
        return

    # Fallback (may not show on some desktops)
    print("[vr-stack-tray] using Gtk.StatusIcon fallback", flush=True)
    icon = Gtk.StatusIcon()
    icon.set_from_icon_name("video-display")
    icon.set_tooltip_text(f"VR Stack Control {APP_VERSION}")
    icon.set_visible(True)

    def on_popup(_icon, button, t):
        menu.popup(None, None, None, None, button, t)

    icon.connect("popup-menu", on_popup)
    Gtk.main()


if __name__ == "__main__":
    main()
